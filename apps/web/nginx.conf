# =============================================================================
# Nginx Configuration -- Modular House Web Frontend
# =============================================================================
# Production-ready configuration for a Vite-built, pre-rendered SPA served
# behind a Traefik reverse-proxy.
#
# Key concerns addressed:
#   1. Correct MIME types for all static asset formats (SVG, WOFF2, etc.).
#   2. Aggressive caching for fingerprinted Vite assets; short cache for HTML.
#   3. SPA fallback via try_files so client-side routing works on hard reload.
#   4. Gzip compression to reduce transfer size.
# =============================================================================

server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    # ------------------------------------------------------------------
    # Gzip compression
    # Reduces transfer size for text-based assets served to the browser.
    # Binary formats (images, fonts) are already compressed and excluded.
    # ------------------------------------------------------------------
    gzip on;
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        image/svg+xml;
    gzip_min_length 256;
    gzip_vary on;

    # ------------------------------------------------------------------
    # Fingerprinted assets produced by Vite (JS, CSS, images, fonts).
    # These file names contain a content hash, making them safe to cache
    # indefinitely. The browser will fetch a new URL when content changes.
    # ------------------------------------------------------------------
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # ------------------------------------------------------------------
    # Favicon and static image files in the document root.
    # A moderate cache lifetime avoids repeated round-trips while still
    # allowing updates within a reasonable window.
    # ------------------------------------------------------------------
    location ~* \.(?:ico|png|svg|webp|jpg|jpeg|gif)$ {
        expires 7d;
        add_header Cache-Control "public";
        access_log off;
    }

    # ------------------------------------------------------------------
    # Font files (WOFF, WOFF2, TTF, OTF, EOT).
    # Fonts rarely change and are safe to cache aggressively.
    # ------------------------------------------------------------------
    location ~* \.(?:woff2?|ttf|otf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # ------------------------------------------------------------------
    # SPA fallback
    # For any request that does not match a physical file or directory,
    # serve index.html so that React Router can handle the route on the
    # client. Pre-rendered routes already have their own index.html files
    # which will be matched first by try_files.
    # ------------------------------------------------------------------
    location / {
        try_files $uri $uri/ /index.html;

        # HTML documents must not be cached aggressively because they
        # reference fingerprinted asset URLs that change on each deploy.
        location ~* \.html$ {
            add_header Cache-Control "no-cache";
        }
    }
}
